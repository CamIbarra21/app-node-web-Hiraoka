<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Rese√±as y comentarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; line-height: 1.4; }
    h1 { margin-bottom: 16px; }
    .actions { margin-bottom: 16px; }
    .rese√±a { border: 1px solid #ddd; border-radius: 8px; padding: 14px; margin-bottom: 16px; }
    .header { display: flex; gap: 12px; align-items: baseline; }
    .title { font-size: 1.1rem; font-weight: 600; }
    .meta { color: #666; font-size: 0.9rem; }
    .rating { font-weight: 600; color: #1a73e8; }
    .imgs { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .imgs img { max-width: 160px; border-radius: 6px; border: 1px solid #ddd; }
    .texto { margin-top: 8px; }
    .comentarios { margin-top: 12px; padding-top: 10px; border-top: 1px dashed #ddd; }
    .comentario { padding: 8px 0; border-bottom: 1px solid #eee; }
    .comentario:last-child { border-bottom: none; }
    .c-meta { color: #666; font-size: 0.85rem; }
    .reacciones { margin-top: 4px; font-size: 0.95rem; }
    .empty { color: #666; font-style: italic; }
    .error { color: #b00020; margin-top: 12px; }
    .loading { color: #555; }
    button { padding: 6px 10px; }
  </style>
</head>
<body>
  <h1>Rese√±as</h1>

  <div class="actions">
    <button id="reload">Recargar</button>
    <span id="status" class="loading" aria-live="polite"></span>
  </div>

  <div id="list"></div>
  <p id="error" class="error" style="display:none;"></p>

  <script>
    const API_RESE√ëAS = '/api/resenas';
    const API_COMENTARIOS = '/api/comentarios';
    const API_REACCIONES = '/api/reacciones';

    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const reloadBtn = document.getElementById('reload');

    function fmtDate(d) {
      try {
        return new Date(d).toLocaleString();
      } catch { return ''; }
    }

    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Error ${res.status} al obtener ${url}`);
      return res.json();
    }

    async function cargarReaccionesComentario(comentarioId) {
      try {
        const qs = `?elemento_tipo=comentario&elemento_id=${encodeURIComponent(comentarioId)}`;
        const data = await fetchJSON(`${API_REACCIONES}${qs}`);
        const likes = data.filter(r => r.tipo === 'like').length;
        const dislikes = data.filter(r => r.tipo === 'dislike').length;
        return { likes, dislikes };
      } catch {
        return { likes: 0, dislikes: 0 };
      }
    }

    async function cargarReaccionesRese√±a(rese√±aId) {
      try {
        const qs = `?elemento_tipo=rese√±a&elemento_id=${encodeURIComponent(rese√±aId)}`;
        const data = await fetchJSON(`${API_REACCIONES}${qs}`);
        const likes = data.filter(r => r.tipo === 'like').length;
        const dislikes = data.filter(r => r.tipo === 'dislike').length;
        return { likes, dislikes };
      } catch {
        return { likes: 0, dislikes: 0 };
      }
    }

    async function cargarComentariosRese√±a(rese√±aId) {
      try {
        const qs = `?rese√±a_id=${encodeURIComponent(rese√±aId)}`;
        const comentarios = await fetchJSON(`${API_COMENTARIOS}${qs}`);
        // Obtener reacciones por comentario en paralelo
        const withReactions = await Promise.all(comentarios.map(async c => {
          const rx = await cargarReaccionesComentario(c._id);
          return { ...c, _rx: rx };
        }));
        return withReactions;
      } catch {
        return [];
      }
    }

    function renderRese√±aCard(r, comentarios, reacciones) {
      const imgs = Array.isArray(r.imagenes) ? r.imagenes : [];
      const producto = r.producto?.nombre || r.producto_id || 'Producto';
      const usuario = r.usuario?.nombre_usuario || r.usuario_id || 'Usuario';
      const imgsHTML = imgs.length
        ? `<div class="imgs">${imgs.map(src => `<img alt="imagen rese√±a" src="${esc(src)}" />`).join('')}</div>`
        : '';

      const comentariosHTML = comentarios.length
        ? comentarios.map(c => `
            <div class="comentario">
              <div class="c-meta"><strong>${esc(c.usuario?.nombre_usuario || c.usuario_id || 'Usuario')}:</strong> <span>${fmtDate(c.fecha_creacion)}</span></div>
              <div class="c-texto">${esc(c.texto)}</div>
              <div class="reacciones">
                üëç ${c._rx.likes} &nbsp;&nbsp; ‚ùå ${c._rx.dislikes}
              </div>
            </div>
          `).join('')
        : `<div class="empty">Sin comentarios.</div>`;


      // Formulario de comentario (solo si hay token)
      const token = localStorage.getItem("token");
      const reaccionBtns = token ? `
        <div class="acciones-reaccion" data-rese√±a="${r._id}">
          <button class="btn-like" data-tipo="like">üëç Like</button>
          <button class="btn-dislike" data-tipo="dislike">‚ùå Dislike</button>
        </div>
      ` : '';
      const formHTML = token ? `
        <form class="form-comentario" data-rese√±a="${r._id}">
          <input type="text" name="texto" placeholder="Escribe un comentario..." required />
          <button type="submit">Comentar</button>
        </form>
      ` : '';

      return `
        <div class="rese√±a">
          <div class="header">
            <div class="title">${esc(r.titulo || 'Rese√±a')}</div>
            <div class="rating">‚òÖ ${typeof r.calificacion === 'number' ? r.calificacion.toFixed(1) : '-'}</div>
          </div>
          <div class="meta">${esc(producto)} ‚Ä¢ por ${esc(usuario)} ‚Ä¢ ${fmtDate(r.fecha_creacion)}</div>
          <div class="texto">${esc(r.texto || '')}</div>
          <div class="reacciones">
            üëç ${reacciones.likes} &nbsp;&nbsp; ‚ùå ${reacciones.dislikes}
          </div>
          ${imgsHTML}
          ${reaccionBtns}
          <div class="comentarios">
            <div class="c-meta"><strong>Comentarios</strong></div>
            ${comentariosHTML}
            ${formHTML}
          </div>
        </div>
      `;

    }

    async function cargarTodo() {
      statusEl.textContent = 'Cargando rese√±as...';
      errorEl.style.display = 'none';
      listEl.innerHTML = '';

      try {
        console.log("Legoooo :)")
        const rese√±as = await fetchJSON(API_RESE√ëAS);
        console.log("XDDDD")

        if (!rese√±as || rese√±as.length === 0) {
          listEl.innerHTML = '<p class="empty">No hay rese√±as disponibles.</p>';
          statusEl.textContent = '';
          return;
        }

        // Para cada rese√±a, cargar sus comentarios y reacciones
        const contenido = await Promise.all(rese√±as.map(async r => {
          const comentarios = await cargarComentariosRese√±a(r._id);
          const reacciones = await cargarReaccionesRese√±a(r._id);
          return renderRese√±aCard(r, comentarios, reacciones);
        }));

        listEl.innerHTML = contenido.join('');
        statusEl.textContent = `Total rese√±as: ${rese√±as.length}`;
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = 'block';
        statusEl.textContent = '';
      }
    }

    // Delegaci√≥n de eventos para formularios de comentario
    document.addEventListener("submit", async (e) => {
      if (e.target.classList.contains("form-comentario")) {
        e.preventDefault();
        const rese√±aId = e.target.dataset.rese√±a;
        const texto = e.target.querySelector("input[name='texto']").value;
        const token = localStorage.getItem("token");

        try {
          const res = await fetch(API_COMENTARIOS, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": token
            },
            body: JSON.stringify({ rese√±a_id: rese√±aId, texto })
          });

          const data = await res.json();
          if (res.ok) {
            alert("Comentario agregado");
            cargarTodo(); // recargar rese√±as y comentarios
          } else {
            alert(data.error || "Error al comentar");
          }
        } catch (err) {
          alert("Error de red");
        }
      }
    });

    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("btn-like") || e.target.classList.contains("btn-dislike")) {
        const tipo = e.target.dataset.tipo;
        const rese√±aId = e.target.closest(".acciones-reaccion").dataset.rese√±a;
        const token = localStorage.getItem("token");

        try {
          const res = await fetch(API_REACCIONES, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": token
            },
            body: JSON.stringify({ elemento_id: rese√±aId, elemento_tipo: "rese√±a", tipo })
          });

          const data = await res.json();
          if (res.ok) {
            alert("Reacci√≥n registrada");
            cargarTodo(); // recargar rese√±as
          } else {
            alert(data.error || "Error al reaccionar");
          }
        } catch {
          alert("Error de red");
        }
      }
    });

    reloadBtn.addEventListener('click', cargarTodo);
    cargarTodo();
  </script>
</body>
</html>